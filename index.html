<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <title>Route Scanner</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --accent: #e94560;
            --accent-glow: rgba(233, 69, 96, 0.3);
            --success: #0cce6b;
            --success-glow: rgba(12, 206, 107, 0.3);
            --warning: #ffa62b;
            --text-primary: #edf2f4;
            --text-secondary: #8d99ae;
            --text-muted: #5c6b7a;
            --border: rgba(255,255,255,0.08);
            --radius: 14px;
            --font-display: 'JetBrains Mono', monospace;
            --font-body: 'DM Sans', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========== HEADER ========== */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), #ff6b8a);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .app-title {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 16px;
            letter-spacing: -0.5px;
        }

        .app-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            font-family: var(--font-display);
        }

        .header-badge {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px 14px;
            font-family: var(--font-display);
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
        }

        /* ========== SCREENS ========== */
        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== HOME SCREEN ========== */
        .home-content {
            padding: 24px 20px;
        }

        .date-display {
            font-family: var(--font-display);
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 24px;
            letter-spacing: 0.5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 28px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #ff6b8a);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 18px 24px;
            font-family: var(--font-body);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 20px var(--accent-glow);
            transition: all 0.2s;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 24px;
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .btn-secondary:active {
            transform: scale(0.98);
            background: var(--bg-secondary);
        }

        .btn-icon {
            font-size: 20px;
        }

        /* ========== ADDRESS LIST ========== */
        .address-list-section {
            margin-top: 8px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: 13px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .clear-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-family: var(--font-display);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .address-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .address-number {
            background: var(--bg-secondary);
            color: var(--text-muted);
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display);
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .address-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .address-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .address-remove:hover {
            color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 14px;
            line-height: 1.5;
        }

        /* ========== CAMERA SCREEN ========== */
        .camera-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 200;
        }

        .camera-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .scan-rectangle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 80px;
            border: 3px solid var(--accent);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.55);
        }

        .scan-rectangle::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            border-radius: 12px;
            box-shadow: 0 0 20px var(--accent-glow), inset 0 0 20px var(--accent-glow);
        }

        .scan-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -70px);
            color: white;
            font-family: var(--font-display);
            font-size: 13px;
            text-align: center;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
            letter-spacing: 0.5px;
        }

        .camera-top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            pointer-events: all;
        }

        .camera-close {
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .camera-count {
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: var(--font-display);
            font-size: 13px;
            backdrop-filter: blur(10px);
        }

        .camera-bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px 20px 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            pointer-events: all;
        }

        .capture-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255,255,255,0.3);
            cursor: pointer;
            position: relative;
            transition: all 0.15s;
        }

        .capture-btn:active {
            transform: scale(0.9);
        }

        .capture-btn.processing {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 166, 43, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(255, 166, 43, 0); }
        }

        .flash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.1s;
        }

        .flash-overlay.flash {
            opacity: 0.5;
        }

        /* ========== CONFIRM SCREEN (overlay on camera) ========== */
        .confirm-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 20;
            display: none;
            flex-direction: column;
            justify-content: center;
            padding: 24px;
            animation: fadeIn 0.3s ease;
        }

        .confirm-overlay.active {
            display: flex;
        }

        .confirm-title {
            font-family: var(--font-display);
            font-size: 14px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .confirm-address-input {
            background: var(--bg-card);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            padding: 16px;
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 16px;
            line-height: 1.5;
            width: 100%;
            min-height: 100px;
            resize: none;
            outline: none;
        }

        .confirm-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            margin-bottom: 24px;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-actions button {
            flex: 1;
            padding: 16px;
            border-radius: var(--radius);
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .btn-confirm-add {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 15px var(--success-glow);
        }

        .btn-confirm-retry {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border) !important;
        }

        /* ========== EXPORT SCREEN ========== */
        .export-content {
            padding: 24px 20px;
        }

        .export-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }

        .export-section-title {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .export-section-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .export-btn {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .export-btn:active {
            transform: scale(0.98);
        }

        .export-btn-clipboard {
            background: linear-gradient(135deg, var(--accent), #ff6b8a);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .export-btn-csv {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border) !important;
        }

        .export-preview {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
        }

        .export-preview-line {
            font-family: var(--font-display);
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }

        .export-preview-line:last-child {
            border-bottom: none;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-family: var(--font-body);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 0;
            margin-bottom: 16px;
        }

        /* ========== LOG SCREEN ========== */
        .log-content {
            padding: 24px 20px;
        }

        .log-entry {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
        }

        .log-date {
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
        }

        .log-count {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .log-addresses {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            display: none;
        }

        .log-addresses.expanded {
            display: block;
        }

        .log-address-item {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 3px 0;
            font-family: var(--font-display);
        }

        .log-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 0;
            margin-top: 6px;
        }

        /* ========== MANUAL ADD ========== */
        .manual-add-content {
            padding: 24px 20px;
        }

        .manual-input {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 16px;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 12px;
        }

        .manual-input:focus {
            border-color: var(--accent);
        }

        .manual-input::placeholder {
            color: var(--text-muted);
        }

        /* ========== TOAST ========== */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-family: var(--font-display);
            font-size: 13px;
            font-weight: 600;
            z-index: 999;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 20px var(--success-glow);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* ========== LOADING ========== */
        .ocr-loading {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: var(--font-display);
            font-size: 12px;
            backdrop-filter: blur(10px);
            display: none;
            z-index: 15;
        }

        .ocr-loading.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hidden canvas for OCR */
        #ocrCanvas {
            display: none;
        }
    </style>
</head>
<body>

    <!-- ========== TOAST ========== -->
    <div id="toast" class="toast"></div>

    <!-- ========== HOME SCREEN ========== -->
    <div id="homeScreen" class="screen active">
        <div class="header">
            <div class="header-left">
                <div class="logo">üìç</div>
                <div>
                    <div class="app-title">ROUTE SCANNER</div>
                    <div class="app-subtitle">Trinity Pharmacy</div>
                </div>
            </div>
            <div class="header-badge" id="addressCount">0 STOPS</div>
        </div>
        <div class="home-content">
            <div class="date-display" id="dateDisplay"></div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">Today's Stops</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalScanned">0</div>
                    <div class="stat-label">Total Scanned</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-primary" onclick="openCamera()">
                    <span class="btn-icon">üì∏</span>
                    Scan Label
                </button>
                <button class="btn-secondary" onclick="showManualAdd()">
                    <span class="btn-icon">‚å®Ô∏è</span>
                    Type Address
                </button>
                <button class="btn-secondary" onclick="showExport()" id="exportBtn" style="display:none;">
                    <span class="btn-icon">üöÄ</span>
                    Send to RoadWarrior
                </button>
            </div>

            <div class="address-list-section">
                <div class="section-header">
                    <div class="section-title">Today's Route</div>
                    <button class="clear-btn" onclick="clearAddresses()" id="clearBtn" style="display:none;">Clear All</button>
                </div>
                <div id="addressList">
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-text">No addresses yet.<br>Scan a label or type one in to get started.</div>
                    </div>
                </div>
            </div>

            <button class="btn-secondary" onclick="showLog()" style="margin-top: 20px;">
                <span class="btn-icon">üìä</span>
                Delivery Log
            </button>
        </div>
    </div>

    <!-- ========== CAMERA SCREEN ========== -->
    <div id="cameraScreen" class="camera-screen" style="display:none;">
        <div class="camera-container">
            <video id="cameraFeed" autoplay playsinline></video>
            <div class="flash-overlay" id="flashOverlay"></div>
            <div class="camera-overlay">
                <div class="scan-label">Align address inside the box</div>
                <div class="scan-rectangle" id="scanRect"></div>
            </div>
            <div class="camera-top-bar">
                <button class="camera-close" onclick="closeCamera()">‚úï</button>
                <div class="camera-count" id="cameraCount">0 scanned</div>
            </div>
            <div class="ocr-loading" id="ocrLoading">
                <div class="spinner"></div>
                <span>Reading address...</span>
            </div>
            <div class="camera-bottom-bar">
                <button class="capture-btn" id="captureBtn" onclick="captureAddress()"></button>
            </div>

            <!-- Confirm overlay -->
            <div class="confirm-overlay" id="confirmOverlay">
                <div class="confirm-title">Detected Address</div>
                <textarea class="confirm-address-input" id="confirmInput" rows="3"></textarea>
                <div class="confirm-hint">Edit if needed, then tap Add to Route</div>
                <div class="confirm-actions">
                    <button class="btn-confirm-retry" onclick="retryCapture()">‚Ü© Retry</button>
                    <button class="btn-confirm-add" onclick="confirmAddress()">‚úì Add to Route</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MANUAL ADD SCREEN ========== -->
    <div id="manualScreen" class="screen">
        <div class="header">
            <div class="header-left">
                <div class="logo">‚å®Ô∏è</div>
                <div>
                    <div class="app-title">TYPE ADDRESS</div>
                </div>
            </div>
        </div>
        <div class="manual-add-content">
            <button class="back-btn" onclick="showHome()">‚Üê Back to Route</button>
            <input type="text" class="manual-input" id="manualInput" placeholder="Enter street address..." autocomplete="street-address">
            <input type="text" class="manual-input" id="manualCity" placeholder="City, State, ZIP" value="Las Vegas, NV ">
            <button class="btn-primary" onclick="addManualAddress()" style="margin-top: 8px;">
                <span class="btn-icon">‚úì</span>
                Add to Route
            </button>
            <p style="color: var(--text-muted); font-size: 13px; margin-top: 12px; text-align: center;">
                Tip: City defaults to Las Vegas. Just enter the street address.
            </p>
        </div>
    </div>

    <!-- ========== EXPORT SCREEN ========== -->
    <div id="exportScreen" class="screen">
        <div class="header">
            <div class="header-left">
                <div class="logo">üöÄ</div>
                <div>
                    <div class="app-title">EXPORT ROUTE</div>
                </div>
            </div>
        </div>
        <div class="export-content">
            <button class="back-btn" onclick="showHome()">‚Üê Back to Route</button>

            <div class="export-section">
                <div class="export-section-title">üìã Copy for RoadWarrior</div>
                <div class="export-section-desc">
                    Copies all addresses (one per line). Open RoadWarrior ‚Üí New Route ‚Üí paste addresses.
                </div>
                <button class="export-btn export-btn-clipboard" onclick="copyToClipboard()">
                    üìã Copy All Addresses
                </button>
            </div>

            <div class="export-section">
                <div class="export-section-title">üìÑ Download CSV</div>
                <div class="export-section-desc">
                    Download as spreadsheet. Import via RoadWarrior's upload tool.
                </div>
                <button class="export-btn export-btn-csv" onclick="downloadCSV()">
                    ‚¨á Download CSV File
                </button>
            </div>

            <div class="export-section">
                <div class="export-section-title">Preview</div>
                <div class="export-preview" id="exportPreview"></div>
            </div>
        </div>
    </div>

    <!-- ========== LOG SCREEN ========== -->
    <div id="logScreen" class="screen">
        <div class="header">
            <div class="header-left">
                <div class="logo">üìä</div>
                <div>
                    <div class="app-title">DELIVERY LOG</div>
                </div>
            </div>
        </div>
        <div class="log-content">
            <button class="back-btn" onclick="showHome()">‚Üê Back to Route</button>
            <div id="logEntries"></div>
        </div>
    </div>

    <!-- Hidden canvas for OCR cropping -->
    <canvas id="ocrCanvas"></canvas>

    <script>
        // ========== STATE ==========
        let addresses = [];
        let deliveryLog = JSON.parse(localStorage.getItem('deliveryLog') || '[]');
        let totalScanned = parseInt(localStorage.getItem('totalScanned') || '0');
        let cameraStream = null;

        // ========== INIT ==========
        function init() {
            // Load today's addresses from session
            const saved = sessionStorage.getItem('todayAddresses');
            if (saved) {
                addresses = JSON.parse(saved);
            }
            updateUI();
            updateDate();
        }

        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('en-US', options).toUpperCase();
        }

        function updateUI() {
            document.getElementById('todayCount').textContent = addresses.length;
            document.getElementById('totalScanned').textContent = totalScanned;
            document.getElementById('addressCount').textContent = addresses.length + ' STOP' + (addresses.length !== 1 ? 'S' : '');
            document.getElementById('exportBtn').style.display = addresses.length > 0 ? 'flex' : 'none';
            document.getElementById('clearBtn').style.display = addresses.length > 0 ? 'block' : 'none';

            const list = document.getElementById('addressList');
            if (addresses.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-text">No addresses yet.<br>Scan a label or type one in to get started.</div>
                    </div>`;
            } else {
                list.innerHTML = addresses.map((addr, i) => `
                    <div class="address-item">
                        <div class="address-number">${i + 1}</div>
                        <div class="address-text">${addr}</div>
                        <button class="address-remove" onclick="removeAddress(${i})">‚úï</button>
                    </div>
                `).join('');
            }

            sessionStorage.setItem('todayAddresses', JSON.stringify(addresses));
        }

        // ========== NAVIGATION ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showHome() {
            showScreen('homeScreen');
        }

        function showManualAdd() {
            showScreen('manualScreen');
            document.getElementById('manualInput').focus();
        }

        function showExport() {
            showScreen('exportScreen');
            const preview = document.getElementById('exportPreview');
            preview.innerHTML = addresses.map((addr, i) =>
                `<div class="export-preview-line">${i + 1}. ${addr}</div>`
            ).join('');
        }

        function showLog() {
            showScreen('logScreen');
            const entries = document.getElementById('logEntries');
            if (deliveryLog.length === 0) {
                entries.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div class="empty-text">No delivery logs yet.<br>Logs are saved when you export to RoadWarrior.</div>
                    </div>`;
            } else {
                entries.innerHTML = deliveryLog.slice().reverse().map((log, i) => `
                    <div class="log-entry">
                        <div class="log-date">${log.date}</div>
                        <div class="log-count">${log.addresses.length} deliveries</div>
                        <button class="log-toggle" onclick="toggleLog(this)">Show addresses ‚ñº</button>
                        <div class="log-addresses">
                            ${log.addresses.map(a => `<div class="log-address-item">‚Ä¢ ${a}</div>`).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleLog(btn) {
            const addrs = btn.nextElementSibling;
            addrs.classList.toggle('expanded');
            btn.textContent = addrs.classList.contains('expanded') ? 'Hide addresses ‚ñ≤' : 'Show addresses ‚ñº';
        }

        // ========== CAMERA ==========
        async function openCamera() {
            const screen = document.getElementById('cameraScreen');
            screen.style.display = 'block';
            document.getElementById('cameraCount').textContent = addresses.length + ' scanned';

            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                document.getElementById('cameraFeed').srcObject = cameraStream;
            } catch (err) {
                showToast('Camera access denied. Check permissions.');
                closeCamera();
            }
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
            document.getElementById('cameraScreen').style.display = 'none';
            document.getElementById('confirmOverlay').classList.remove('active');
            updateUI();
        }

        async function captureAddress() {
            const btn = document.getElementById('captureBtn');
            const loading = document.getElementById('ocrLoading');
            const flash = document.getElementById('flashOverlay');

            // Flash effect
            flash.classList.add('flash');
            setTimeout(() => flash.classList.remove('flash'), 200);

            btn.classList.add('processing');
            loading.classList.add('active');

            try {
                // Get the video frame
                const video = document.getElementById('cameraFeed');
                const canvas = document.getElementById('ocrCanvas');
                const ctx = canvas.getContext('2d');

                // Set canvas to video dimensions
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                // Calculate the crop region matching the scan rectangle
                // Rectangle is 85% width, 80px height (scaled to viewport), centered
                const videoAspect = video.videoWidth / video.videoHeight;
                const viewW = video.clientWidth;
                const viewH = video.clientHeight;

                const rectW = viewW * 0.85;
                const rectH = 80;
                const rectX = (viewW - rectW) / 2;
                const rectY = (viewH - rectH) / 2;

                // Scale to actual video pixel coordinates
                const scaleX = video.videoWidth / viewW;
                const scaleY = video.videoHeight / viewH;

                const cropX = Math.max(0, rectX * scaleX);
                const cropY = Math.max(0, rectY * scaleY);
                const cropW = Math.min(rectW * scaleX, video.videoWidth - cropX);
                const cropH = Math.min(rectH * scaleY, video.videoHeight - cropY);

                // Create cropped canvas
                const cropCanvas = document.createElement('canvas');
                cropCanvas.width = cropW;
                cropCanvas.height = cropH;
                const cropCtx = cropCanvas.getContext('2d');
                cropCtx.drawImage(canvas, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

                // Run OCR on cropped region
                const result = await Tesseract.recognize(cropCanvas, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const pct = Math.round(m.progress * 100);
                            loading.querySelector('span').textContent = `Reading... ${pct}%`;
                        }
                    }
                });

                const text = result.data.text.trim();
                loading.querySelector('span').textContent = 'Reading address...';

                if (text.length > 3) {
                    // Clean up the OCR text
                    const cleaned = cleanAddress(text);
                    document.getElementById('confirmInput').value = cleaned;
                    document.getElementById('confirmOverlay').classList.add('active');
                } else {
                    showToast('Could not read text. Try repositioning.');
                }

            } catch (err) {
                console.error('OCR error:', err);
                showToast('Scan failed. Try again.');
            }

            btn.classList.remove('processing');
            loading.classList.remove('active');
        }

        function cleanAddress(text) {
            // Clean common OCR artifacts
            let cleaned = text
                .replace(/\n/g, ' ')
                .replace(/\s+/g, ' ')
                .replace(/[|{}[\]]/g, '')
                .trim();
            return cleaned;
        }

        function confirmAddress() {
            const input = document.getElementById('confirmInput');
            const addr = input.value.trim();
            if (addr) {
                addresses.push(addr);
                totalScanned++;
                localStorage.setItem('totalScanned', totalScanned);
                document.getElementById('cameraCount').textContent = addresses.length + ' scanned';
                showToast('‚úì Address added');
            }
            document.getElementById('confirmOverlay').classList.remove('active');
            input.value = '';
        }

        function retryCapture() {
            document.getElementById('confirmOverlay').classList.remove('active');
            document.getElementById('confirmInput').value = '';
        }

        // ========== MANUAL ADD ==========
        function addManualAddress() {
            const street = document.getElementById('manualInput').value.trim();
            const city = document.getElementById('manualCity').value.trim();

            if (!street) {
                showToast('Enter a street address');
                return;
            }

            const fullAddr = city ? `${street}, ${city}` : street;
            addresses.push(fullAddr);
            totalScanned++;
            localStorage.setItem('totalScanned', totalScanned);
            document.getElementById('manualInput').value = '';
            showToast('‚úì Address added');
            updateUI();
            showHome();
        }

        // ========== ADDRESS MANAGEMENT ==========
        function removeAddress(index) {
            addresses.splice(index, 1);
            updateUI();
        }

        function clearAddresses() {
            if (confirm('Clear all addresses from today\'s route?')) {
                addresses = [];
                updateUI();
            }
        }

        // ========== EXPORT ==========
        function copyToClipboard() {
            const text = addresses.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                // Save to log
                saveToLog();
                showToast('‚úì Copied! Open RoadWarrior and paste.');
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                saveToLog();
                showToast('‚úì Copied! Open RoadWarrior and paste.');
            });
        }

        function downloadCSV() {
            const header = 'Address\n';
            const csv = header + addresses.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `route_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            saveToLog();
            showToast('‚úì CSV downloaded');
        }

        function saveToLog() {
            const today = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Check if we already have an entry for today
            const existing = deliveryLog.findIndex(l => l.date === today);
            if (existing >= 0) {
                deliveryLog[existing].addresses = [...addresses];
            } else {
                deliveryLog.push({
                    date: today,
                    addresses: [...addresses]
                });
            }

            localStorage.setItem('deliveryLog', JSON.stringify(deliveryLog));
        }

        // ========== TOAST ==========
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ========== KEYBOARD SHORTCUT ==========
        document.getElementById('manualInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                addManualAddress();
            }
        });

        // Init
        init();
    </script>
</body>
</html>
